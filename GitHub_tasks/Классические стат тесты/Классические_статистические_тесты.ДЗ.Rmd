---
title: "Классические_статистические_тесты.ДЗ"
author: "Oleg Arnaut"
date: "2024-11-25"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)

```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез. В качестве задания протестируйте их, используя соответствующие статистические критерии. Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы. При необходимости аргументируйте выбор одностороннего теста. 
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.


* Решение необходимо загружать в формате Rmd (воспроизводимый код).
** Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr
*** Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).


# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30) ? 

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample()

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- sample()

```

#Решение
```{r}
# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c("high", "low"), each = sample_size / 2)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)
cardio <- ifelse(activity == "high",
                 sample(c(TRUE, FALSE), size = sample_size, replace = TRUE, prob = c(0.5, 0.5)),
                 sample(c(TRUE, FALSE), size = sample_size, replace = TRUE, prob = c(0.6, 0.4)))

table(Activity = activity, Cardio = cardio)

chisq.test(table(Activity = activity, Cardio = cardio))

fisher.test(table(Activity = activity, Cardio = cardio))
```
```{r}
# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c("high", "low"), each = sample_size / 2)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.4 vs 0.7)
cardio <- ifelse(activity == "high",
                 sample(c(TRUE, FALSE), size = sample_size, replace = TRUE, prob = c(0.5, 0.5)),
                 sample(c(TRUE, FALSE), size = sample_size, replace = TRUE, prob = c(0.6, 0.4)))

table(Activity = activity, Cardio = cardio)

chisq.test(table(Activity = activity, Cardio = cardio))

fisher.test(table(Activity = activity, Cardio = cardio))

```

```{r}
#H0 - низкая физическая активность не ассоциирована с частотой возникновения сердечно-сосудистых заболеваний
#H1 - низкая физическая активность ассоциирована с частотой возникновения сердечно-сосудистых заболеваний

#Уровень значимости а=0.05

#Так как зависимая переменная является дихотомической (наличие или отсутствие сердечно-сосудистых заболеваний), и независимая переменная также дихотомическая (уровень физической активности), мы можем использовать хи-квадрат для независимых выборок.


#Критическое значение статистики: Так как хи-квадарат - односторонний тест, критическое значение уровня значимости 0.05 равно 3.84 


#Наблюдаемое значение статистики: для n=30: 0.54299, для n=100: 0

#Стат.значимость: p-value =  0.4612 для n=30 и p-value = 1 для n=100. Для выборок n=100 и n=30 мы не можем отвергнуть нулевую гипотезу и сделать вывод о значимсоти результатат (то есть ассоциации нет).При использовании критерия Фишера также p-value больше 0.05. Но если взять выборку 1000, то p-value будет меньше 0.05 (покажет ассоциацию). 

#Практическая значимость: Практическая значимость, я считаю, что есть.  Так как на выборке из 100 и 30 человек не получается увиджеть ассоциацию (выборки маленькие). 
```


# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.

## Генерация данных 

```{r}
# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
n <- 80

# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
m1 <- 130
sd1 <- 5
group1 <- rnorm(n, m1, sd1)  # экспериментальная группа


# Генерация данных для группы со стандартным лечением
m2 <- 135
sd2 <- 7
group2 <- rnorm(n, m2, sd2)# контрольная группа

```

## Решение
```{r}
#H0-среднее артериальное давление при лечении новым методом не изменилось
#H1 - среднее артериальное давление при лечении новым методом ниже 

#Уровень значимости а=0.05

#При сравнении средних значений двух выборок (нормально распределенных) можно использовать t-test. 

t.test(group1, group2)

#Критическое значение статитстики: число степеней свободы df= 80+80-2 = 158, уровень значимости 0.05,следовательно, критическое значение t-статитстики = 1.65

#Наблюдаемое значение статистики: t = -4.4442

#Стат.значимость: p-value = 1.684e-05 - меньше 0.05, значит, что нулевую гипотезу отвергаем. Есть значительные различия в артериальном давлении между группами. 

#Практическая значимость: Результаты показывают, что артериальное давление в группе с новым методом лечения существенно ниже, чем в группе со стандартным лечением, следовательно, новый метод лечения эффективен

```


# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(n = 30, )

# Генерация данных после реабилитации
after <- rbinom( ... )  


```

## Решение (для биномиального распределения)

```{r}
# Установка начального числа для воспроизводимости результатов
set.seed(42)

# Размер выборки
sample_size <- 30
n_patients <- 30

# Параметры биномиального распределения для физической активности до реабилитации
prob_before <- 0.5  # Вероятность успеха соответствует среднему значению 50/100

# Генерация данных до реабилитации
before <- rbinom(n = sample_size, size = 100, prob = prob_before)

# Параметры биномиального распределения для физической активности после реабилитации
prob_after <- 0.6  # Вероятность успеха соответствует среднему значению 60/100

# Генерация данных после реабилитации
after <- rbinom(n = sample_size, size = 100, prob = prob_after)

reabil_data <- tibble(
  Patient_ID = 1:n_patients,
  Physical_Activity_Before = before,
  Physical_Activity_After = after
)

#H0 - при внедрении новой программы реабилитации не произошло улучшение физической активности
#H1 - физическая активность улучшилась после применения новой программы реабилитации

#Уровень значимости а = 0.05

#Можно использовать t-test. При этом в данной ситуации лучше использовать односторонний тест, чтобы доказать, что улучшение дейтствительно произошло

t.test(reabil_data$Physical_Activity_After, reabil_data$Physical_Activity_Before, 
                               paired = TRUE, alternative = "greater")

#Критическое значение статистики: при числе степеней свободы df=30-1 = 29 и уровне значимости 0.05 критическое значение t=1.699

#Наблюдаемое значение статистики: t= 7.4892

#Стат.значимость:p-value = 1.483e-08, следовательно, мы можем отвергнуть нулевую гипотезу, то есть статистически результат  значим (новая программа реабилитации улучшает физическую активность). При этом наблюдаемое значение больше  критического значения (можем отклонить нулевую гипотезу)

#Практическая значимость: Разница между средними значениями физической активности до и после реабилитации составила около 10 единиц, что указывает на улучшение физической активности после реабилитационного вмешательства.
```

#Решение (если оценивать по баллам как нормальное распределение)
```{r}
# Установка начального числа для воспроизводимости результатов
set.seed(42)

# Размер выборки
sample_size <- 30
n_patients <- 30

# Параметры нормального распределения для физической активности до реабилитации
mean_before <- 50
sd_before <- 10

# Генерация данных до реабилитации
before_1 <- rnorm(n = sample_size, mean = mean_before, sd = sd_before)

# Параметры нормального распределения для физической активности после реабилитации
mean_after <- 60
sd_after <- 10

# Генерация данных после реабилитации
after_1 <- rnorm(n = sample_size, mean = mean_after, sd = sd_after)

reabil_data_1 <- tibble(
  Patient_ID = 1:n_patients,
  Physical_Activity_Before = before_1,
  Physical_Activity_After = after_1
)


#H0 - при внедрении новой программы реабилитации не произошло улучшение физической активности
#H1 - физическая активность улучшилась после применения новой программы реабилитации

#Уровень значимости а = 0.05

#Можно использовать t-test. При этом в данной ситуации лучше использовать односторонний тест, чтобы доказать, что улучшение действительно произошло

t.test(reabil_data_1$Physical_Activity_After, reabil_data_1$Physical_Activity_Before, 
                               paired = TRUE, alternative = "greater")

#Критическое значение статистики: при числе степеней свободы df=30-1 = 29 и уровне значимости 0.05 критическое значение t=1.699

#Наблюдаемое значение статистики: t= 2.4726

#Стат.значимость:p-value = 1, следовательно, мы можем отвергнуть нулевую гипотезу, то есть статистически результат значим (новая программа реабилитации не улучшает физическую активность). При этом наблюдаемое значение больше критического значения (можем отклонить нулевую гипотезу)

#Практическая значимость: Разница между средними значениями физической активности до и после реабилитации составила около 8 единиц (средняя разница), что указывает на улучшение физической активности после реабилитационного вмешательства.
```


# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- ...

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- ...

    
```

## Решение

```{r}
# Устанавливаем начальное значение генератора случайных чисел для воспроизводимости результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200

# Генерация данных по статусу лечения (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- rep(c("Новый метод", "Стандарт"), each = sample_size / 2)

# Вероятность возврата к нормальной физической активности при новом методе лечения
prob_new_method <- 0.70
# Вероятность возврата к нормальной физической активности при стандартном лечении
prob_standard <- 0.65

# Создание вектора вероятностей в зависимости от типа лечения
probs <- ifelse(treatment == "Новый метод", prob_new_method, prob_standard)

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- rbinom(n = sample_size, size = 1, prob = probs)

table(Treatment = treatment, Activity = activity)


#H0 - доля вернувшихся к нормальной физической активности после нового и старого лечения одинакова
#H1 - доля вернувшихся к нормальной физической активности после применения нового лечения увеличилась

#Уровень значимости а=0.05

#Поскольку цель заключается в сравнении двух пропорций (вероятностей возвращения к физической активности между двумя группами) и группы достаточно большие (по 100 человек каждая), можем применить z-тест для сравнения пропорций.

# Доли успехов в каждой группе (смотрим по сгенерированным данным)
p1 <- sum(activity[treatment == "Новый метод"]) / length(activity[treatment == "Новый метод"])
p2 <- sum(activity[treatment == "Стандарт"]) / length(activity[treatment == "Стандарт"])

# Средняя вероятность по двум выборкам
P_hat <- mean(activity)

# Статистика Z
z_statistic <- (p1 - p2) / sqrt(P_hat * (1 - P_hat) * (1/100 + 1/100))
z_statistic 


#Наблюдаемое значение статистики: 0.7343815

# Критическое значение для одностороннего теста при уровне значимости 0.05
qnorm(0.95)

#Стат.значимость: рассчитанное значение z меньше критического значения, следовательно, мы не можем отвергнуть нулевую гипотезу. 

#Практическая значимость: статистически разница между долями несущественна. На практике, я считаю, что это хороший результат, так как на выборке из 200 человек вернулись к нормальной физической активности 140 человек (вместо 130). Но, думаю, чтобы действительно доказать, что новый метод увеличивает процент (долю) людей, вернувшихся к нормальной физической активности после инфаркта, нужно проводить исследования на выборке больше или же повторно (несколько раз) проводить исследование, чтобы убедиться в эффективности лечения, так как в изначальной выборке могли быть люди, которые просто довольно быстро восстановились (не из-за нового метода лечения), что повлияло на результат.
```


# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- ...

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- ...

```

## Решение
```{r}
# Устанавливаем начальное значение генератора случайных чисел для воспроизводимости
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- sample(c(0, 1), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))


# Генерация данных после медитации (бинарная переменная).
# После медитации вероятность наличия стресса уменьшается (0.2 vs 0.4)
after <- ifelse(
  before == 1,
  sample(c(0, 1), size = sum(before == 1), replace = TRUE, prob = c(0.6, 0.4)),
  sample(c(0, 1), size = sum(before == 0), replace = TRUE, prob = c(0.8, 0.2))
)

table(Before = before, After = after)

# Таблица сопряженности
table <- matrix(c(sum(before == 0 & after == 0),
                  sum(before == 0 & after == 1),
                  sum(before == 1 & after == 0),
                  sum(before == 1 & after == 1)), nrow = 2, byrow = TRUE)
colnames(table) <- c("After=0", "After=1")
rownames(table) <- c("Before=0", "Before=1")



# Применение критерия МакНемара
mcnemar.test(table(Before = before, After = after), correct = FALSE)

#H0 - Применение медитации в течение 8 недель не повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности
#H1 - Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности

#Уровень значимости а=0.05

#Так как мы имеем дело с парными данными (до и после одного и того же наблюдения), наиболее подходящим будет критерий МакНемара (McNemar's test). Этот тест используется для сравнения двух связанных выборок, представленных в виде бинарной переменной.

#Критическое значение статитстики: Так как у нас односторонняя альтернатива, мы ищем критическое значение при уровне значимости 0.025. Критическое значение для критерия МакНемара определяется по распределению хи-квадрат. Критическое значение примерно 5.024

#Наблюдаемое значение статистики: McNemar's chi-squared = 7.3636

#Стат.значимость: p-value = 0.006656 (меньше 0.05), следовательно, мы можем отвергнуть нулевую гипотезу. Также критическое значение t-статистики меньше наблюдаемого (отвергаем H0). 

#Практическая значимость: вероятность наличия стресса значитально снизилась после медитации (в 2 раза снизился уровень стресса). Медитация эффективна в отношении снижения стресса у людей с тревожностью.

```

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- ...  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- ...  # контрольная группа

```

## Решение

```{r}
# Зафиксировать генератор случайных чисел для воспроизводимости результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20

# Генерация данных для экспериментальной группы (альтернативный метод лечения)
group1 <- rnorm(sample_size, mean = 55, sd = 12)

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 68, sd = 14)

# Создание data.frame
treatment_data <- tibble(
  Group1 = group1,
  Group2 = group2
)


#H0 - Применение альтернативного метода лечения для пациентов с биполярным расстройством не приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение
#H1 - Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение

#Уровень значимости а=0.05

#Поскольку у нас две независимые группы с непрерывными данными, мы можем использовать t-тест для независимых выборок. Этот тест подходит для проверки разницы средних значений между двумя независимыми группами. Так как мы ожидаем, что средний уровень симптомов в одной группе будет ниже, нежели в другой, следует выбрать односторонний t-тест.


#Критическое значение статистики: при уровне значимости 0.05 и степенях свободы df=n+m-2 = 20+20-2 = 38 критическое значение t-статистики будет приблизительно 1.686 

#Наблюдаемое значение статистики: рассчитываем значение t-статистики

t.test(treatment_data$Group1, treatment_data$Group2, alternative = "less", var.equal = FALSE)

#Стат.значимость:После расчёта t-статистики, мы сравниваем её с критическим значением. Если наблюдаемое значение превышает критическое, то отклоняется нулевая гипотеза в пользу альтернативной. Также можно рассчитать p-value, которое показывает вероятность получения таких же или более экстремальных результатов при условии верности нулевой гипотезы.

#Получилось t = -1.3954 (рассчитанное значение) и t = 1.686 (критическое значение). Наблюдаемое(рассчитанное) значение не превышает критическое, следовательно, мы не можем отвергнуть нулевую гипотезу (p-value больше 0.05).То есть размер эффекта от применения нового метода лечения не имеет статистичекой значимости.

#Практическая значимость: размер эффекта не имеет статистичекой значимости. На практике нужно увеличить выборку, чтобы оценить эффект, так как на выборке 20 человек в каждоу группе может быть большая вариация признака, что влияет на среднее дисперсии. Трудно сделать выводы об эффективности лечения.

```


# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных  

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(..., ..., ..., ...), nrow = 2)

df <- rmvnorm(n = ..., 
              mean = ..., 
              sigma = ...) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```

## Решение (дополните решение визуализацией)
```{r}
library(mvtnorm)
# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В исследуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1), nrow = 2)

# Генерация данных из многомерного нормального распределения
df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
    as_tibble() %>%
    setNames(c("HoursOfSleep", "StressLevel"))


#H0 - длительность сна (в часах) не ассоциирована с уровенем стресса у студентов
#H1 - длительность сна (в часах) ассоциирована с уровенем стресса у студентов (есть отрицательная корреляция)

#Уровень значимости а=0.05

#Так как мы проверяем гипотезу о существовании линейной зависимости между двумя количественными признаками, то можно использовать коэффициент корреляции Пирсона. Так как альтернативная гипотеза направлена в сторону отрицательной корреляции, то проводим односторонний тест.

cor.test(df$HoursOfSleep, df$StressLevel, alternative = "less")

#Критическое значение статистики: df = n-2 = 100-2 = 98. Для n=100 и df=98 критическое значение t = 1.66

#Наблюдаемое значение статистики: -6.0621

#Стат.значимость: сравниваем критическое значение t (t = 1.66) и рассчитанное занчение t-статистики (t = -6.0621) (рассчитанное значение меньше критического). По p-value 1.255e-08 можно сделать вывод о том, что результат имеет статистическую значимость.

#Практическая значимость: коэффициент корреляции равен примерно -0.5, что говорит об умереннной отрицательной корреляции между переменными. 

df %>% 
  ggplot(aes(x = HoursOfSleep, y = StressLevel)) + 
  geom_point(size = 1.1) + 
  labs(x = "Длительности сна", 
       y = "Уровень стресса") + 
  geom_smooth(method = "lm") +
  theme_bw()


```

#Некоторые проблемы, возникшие при выполнении задания:
#функция sample ( с указанием вероятности 0.5, когда нужно соотношение 1:1) генерит данные неравномерно (например, надо 25 и 25, а создает 19 и 26). Есть вариант использовать функцию rep, но тогда она создает выборку 10101010 по порядку (нет рандомизации). И при этом очень сильно меняются результаты: может влиять на p-value и общий вывод. Не совсем понимаю, какую функцию использовать для генерации данных

#в задании 4 не поняла, почему надо использовать rbinom








